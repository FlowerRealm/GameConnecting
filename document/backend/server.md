# 后端服务器 (`server.js`)

这是后端应用程序的主入口点。它负责设置 Express 服务器、配置中间件、挂载 API 路由、初始化 Socket.IO，并处理集群以实现更好的性能和可靠性。

## 主要功能

- **集群模式**: 如果 `ENABLE_CLUSTERING` 环境变量设置为 `true`，应用程序将以集群模式启动，为每个 CPU 内核创建一个工作进程，以最大限度地提高性能。
- **Express 服务器设置**: 创建并配置一个 Express 应用程序实例。
- **CORS 配置**: 为一组允许的源配置跨源资源共享 (CORS)，使其能够安全地与前端应用程序通信。
- **中间件**: 
    - `cors`: 处理 CORS 策略。
    - `compression`: 压缩响应体以提高性能。
    - `express.json`: 解析传入的 JSON 请求体。
    - **性能监控**: 一个自定义中间件，用于记录和警告响应时间较长的慢请求。
    - **API 密钥验证**: (已注释掉) 一个用于验证 `x-api-key` 请求头的中间件。
- **路由**: 挂载所有 API 路由，包括 `auth`, `rooms`, `admin`, `organizations`, `users` 等。
- **健康检查端点**: 提供一个 `/health` 端点，用于检查服务器的状态。
- **Socket.IO 集成**: 初始化 Socket.IO 服务器并将其附加到 HTTP 服务器，以实现实时通信功能。
- **错误处理**: 一个全局错误处理中间件，用于捕获和处理应用程序中的意外错误。
- **优雅关闭**: 监听 `SIGTERM` 信号，以确保在进程终止时能够优雅地关闭服务器。

## 启动服务器

可以通过以下命令启动服务器：

```bash
node backend/server.js
```

## 环境变量

- `PORT`: 服务器监听的端口号（默认为 `12001`）。
- `ENABLE_CLUSTERING`: 设置为 `true` 以启用集群模式。
- `FRONTEND_URL`: 额外的前端 URL，用于添加到 CORS 允许列表中。
- `NODE_ENV`: 应用程序的运行环境（例如 `development`, `production`）。在开发模式下，错误响应会包含更详细的信息。
