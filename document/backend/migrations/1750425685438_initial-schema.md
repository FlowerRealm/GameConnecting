# 初始数据库模式 (`1750425685438_initial-schema.js`)

该迁移文件定义了应用程序的初始数据库模式，包括多个核心表和用于自动更新时间戳的触发器函数。

## `up` 函数

`up` 函数负责创建数据库中的所有初始结构：

1.  **`trigger_set_timestamp()` 函数**: 创建一个 PostgreSQL 函数，用于在行更新时自动设置 `updated_at` 列为当前时间。

2.  **`user_profiles` 表**: 
    -   存储用户资料，包括 `id` (引用 `auth.users` 的 `id` 并级联删除)、`username` (唯一)、`note`、`role`、`status`、`approved_by`、`approved_at` 和 `admin_note`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

3.  **`friendships` 表**: 
    -   记录用户之间的好友关系，包括 `user_id_1` 和 `user_id_2` (引用 `auth.users` 并级联删除)、`status` 和 `action_user_id`。
    -   确保 `user_id_1` 小于 `user_id_2` 以避免重复记录。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

4.  **`rooms` 表**: 
    -   存储房间（服务器）信息，包括 `id`、`name`、`description`、`creator_id` (引用 `auth.users` 并级联删除)、`room_type` 和 `last_active_at`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

5.  **`room_members` 表**: 
    -   记录房间成员，包括 `room_id` (引用 `rooms` 并级联删除)、`user_id` (引用 `auth.users` 并级联删除)、`role`、`joined_at` 和 `last_active`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

6.  **`room_join_requests` 表**: 
    -   存储用户加入房间的请求，包括 `room_id` (引用 `rooms` 并级联删除)、`user_id` (引用 `auth.users` 并级联删除) 和 `status`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

7.  **`organizations` 表**: 
    -   存储组织信息，包括 `id`、`name` (唯一)、`description`、`created_by` (引用 `user_profiles` 并设置为空)、`is_publicly_listable`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

8.  **`user_organization_memberships` 表**: 
    -   记录用户在组织中的成员资格，包括 `user_id` (引用 `user_profiles` 并级联删除)、`organization_id` (引用 `organizations` 并级联删除)、`role_in_org` 和 `status_in_org`。
    -   `created_at` 和 `updated_at` 字段。
    -   为 `updated_at` 字段应用 `set_timestamp` 触发器。

## `down` 函数

`down` 函数负责回滚 `up` 函数所做的更改，即以相反的顺序删除所有创建的表和函数：

-   删除 `user_organization_memberships` 表及其触发器。
-   删除 `organizations` 表及其触发器。
-   删除 `room_join_requests` 表及其触发器。
-   删除 `room_members` 表及其触发器。
-   删除 `rooms` 表及其触发器。
-   删除 `friendships` 表及其触发器。
-   删除 `user_profiles` 表及其触发器。
-   删除 `trigger_set_timestamp()` 函数。
